<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.brh.channel.web.dao.ChannelInfoStatisticsDao">


	<select id="queryTotalChannelRegist" resultType="int">
		select count(*)
		from
		(SELECT ROWNUM RN, UI.PHONETEL, UI.REALNAME,
		REPLACE(UI.CERTID,SUBSTR (UI.CERTID,7,4),'****') AS CERTID,
		CL.SUBITEMNAME AS CHANNELNAME,
		UI.INPUTTIME, UF.PHONETEL AS
		REFERRERPHONE,
		(CASE WHEN UR.ACTIVATEFLAG IS NULL THEN '未开户'
		WHEN
		UR.ACTIVATEFLAG = '0' THEN '未激活'
		WHEN UR.ACTIVATEFLAG = '1' THEN '已开户'
		ELSE UR.ACTIVATEFLAG
		END) AS AUTHSTATUS,
		(CASE WHEN UR.ACTIVATEFLAG =
		'1' AND UR.CARDNO IS NOT NULL THEN '已绑卡'
		ELSE '未绑卡'
		END) AS CARDSTATUS
		FROM NEW_PORTAL.V_USER_INFO_JOIN UI,
		(SELECT * FROM
		NEW_PORTAL.USER_ACCOUNT_RELATION WHERE ACCTROLE = '02') UR,
		(SELECT *
		FROM NEW_PORTAL.SUB_CODE_LIBRARY WHERE CODENO =
		'PLATFORMTYPE') CL,
		NEW_PORTAL.V_USER_INFO_JOIN UF
		WHERE UI.USERID = UR.USERID(+)
		AND
		UI.CHANNEL = CL.SUBITEMNO(+)
		AND UI.REFERRER = UF.USERID(+)
		AND
		UI.USERTYPE = '01' AND UI.CHANNEL like #{channel}||'%' )m
	</select>
	<select id="getChannelRegistInfoList" resultType="com.brh.channel.web.service.dto.ChannelRegistDto">
		select m.* from (SELECT ROWNUM RN, UI.PHONETEL, UI.REALNAME,
		REPLACE(UI.CERTID,SUBSTR (UI.CERTID,7,4),'****') AS CERTID, CL.SUBITEMNAME AS CHANNELNAME,
		UI.INPUTTIME, UF.PHONETEL AS
		REFERRERPHONE,
		(CASE WHEN UR.ACTIVATEFLAG IS NULL THEN '未开户'
		WHEN
		UR.ACTIVATEFLAG = '0' THEN '未激活'
		WHEN UR.ACTIVATEFLAG = '1' THEN '已开户'
		ELSE UR.ACTIVATEFLAG
		END) AS AUTHSTATUS,
		(CASE WHEN UR.ACTIVATEFLAG =
		'1' AND UR.CARDNO IS NOT NULL THEN '已绑卡'
		ELSE '未绑卡'
		END) AS CARDSTATUS
		FROM NEW_PORTAL.V_USER_INFO_JOIN UI,
		(SELECT * FROM
		NEW_PORTAL.USER_ACCOUNT_RELATION WHERE ACCTROLE = '02') UR,
		(SELECT *
		FROM NEW_PORTAL.SUB_CODE_LIBRARY WHERE CODENO =
		'PLATFORMTYPE') CL,
		NEW_PORTAL.V_USER_INFO_JOIN UF
		WHERE UI.USERID = UR.USERID(+)
		AND
		UI.CHANNEL = CL.SUBITEMNO(+)
		AND UI.REFERRER = UF.USERID(+)
		AND
		UI.USERTYPE = '01' AND UI.CHANNEL like #{channel}||'%'
		AND UI.INPUTTIME
		BETWEEN #{startDay} AND #{endDay}
		ORDER BY UI.INPUTTIME DESC, UI.USERID
		DESC )m
		<if test="offset != null and limit != null">
			where rn between #{offset} and #{limit}
		</if>
	</select>
	<select id="getChannelRegistInfoListTotal" resultType="com.brh.channel.web.service.dto.ChannelRegistDto">
		SELECT
		UI.PHONETEL, UI.REALNAME,
		REPLACE(UI.CERTID,SUBSTR (UI.CERTID,7,4),'****') AS CERTID, CL.SUBITEMNAME AS CHANNELNAME,
		UI.INPUTTIME, UF.PHONETEL AS REFERRERPHONE,UI.CHANNEL,
		(CASE WHEN
		UR.ACTIVATEFLAG IS NULL THEN '未开户'
		WHEN UR.ACTIVATEFLAG = '0' THEN
		'未激活'
		WHEN UR.ACTIVATEFLAG = '1' THEN '已开户'
		ELSE UR.ACTIVATEFLAG
		END) AS
		AUTHSTATUS,
		(CASE WHEN UR.ACTIVATEFLAG = '1' AND UR.CARDNO IS NOT NULL
		THEN '已绑卡'
		ELSE '未绑卡'
		END) AS CARDSTATUS
		FROM NEW_PORTAL.V_USER_INFO_JOIN
		UI,
		(SELECT * FROM NEW_PORTAL.USER_ACCOUNT_RELATION WHERE ACCTROLE =
		'02') UR,
		(SELECT * FROM NEW_PORTAL.SUB_CODE_LIBRARY WHERE CODENO =
		'PLATFORMTYPE') CL,
		NEW_PORTAL.V_USER_INFO_JOIN UF
		WHERE UI.USERID =
		UR.USERID(+)
		AND UI.CHANNEL = CL.SUBITEMNO(+)
		AND UI.REFERRER =
		UF.USERID(+)
		AND UI.USERTYPE = '01' AND UI.CHANNEL like #{channel}||'%'
		AND UI.INPUTTIME BETWEEN #{startDay} AND #{endDay}
		ORDER BY
		UI.INPUTTIME DESC, UI.USERID DESC
	</select>
	<select id="queryTotalChannelInvest" resultType="int">
		select count(*)
		from
		(SELECT ROWNUM RN, UI.PHONETEL, UI.REALNAME,
		CR.INPUTTIME,
		CR.AMOUNT, PI.PROJECTNAME, CR.CHANNEL
		FROM
		NEW_PORTAL.CUSTODY_INVEST_RECORD CR,
		NEW_PORTAL.V_USER_INFO_JOIN UI,
		NEW_PORTAL.PROJECT_INFO PI
		WHERE CR.USERID = UI.USERID
		AND CR.PROJECTID
		= PI.SERIALNO
		AND CR.STATUS = '10'
		AND UI.USERTYPE = '01'
		AND PI.STATUS
		NOT IN ('0', '1', '2') AND CR.CHANNEL LIKE #{channel}||'%'
		AND
		CR.INPUTTIME
		BETWEEN #{startDay} AND #{endDay})m
	</select>
	<select id="getChannelInvestInfoList" resultType="com.brh.channel.web.service.dto.ChannelInvestDto">
		SELECT M.* FROM (SELECT ROWNUM RN, UI.PHONETEL, UI.REALNAME,
		CR.INPUTTIME, CR.AMOUNT, PI.PROJECTNAME, CR.CHANNEL
		FROM
		NEW_PORTAL.CUSTODY_INVEST_RECORD CR,
		NEW_PORTAL.V_USER_INFO_JOIN UI,
		NEW_PORTAL.PROJECT_INFO PI
		WHERE CR.USERID = UI.USERID
		AND CR.PROJECTID
		= PI.SERIALNO
		AND CR.STATUS = '10'
		AND UI.USERTYPE = '01'
		AND PI.STATUS
		NOT IN ('0', '1', '2') AND CR.CHANNEL LIKE #{channel}||'%'
		AND
		CR.INPUTTIME
		BETWEEN #{startDay} AND #{endDay}
		ORDER BY CR.INPUTTIME
		DESC, UI.USERID DESC)M
		<if test="offset != null and limit != null">
			where rn between #{offset} and #{limit}
		</if>
	</select>
	<select id="getChannelInvestInfoListTotal" resultType="com.brh.channel.web.service.dto.ChannelInvestDto">
		SELECT
		ROWNUM RN, UI.PHONETEL, UI.REALNAME,
		CR.INPUTTIME, CR.AMOUNT,
		PI.PROJECTNAME, CR.CHANNEL
		FROM NEW_PORTAL.CUSTODY_INVEST_RECORD CR,
		NEW_PORTAL.V_USER_INFO_JOIN UI,
		NEW_PORTAL.PROJECT_INFO PI
		WHERE
		CR.USERID = UI.USERID
		AND CR.PROJECTID = PI.SERIALNO
		AND CR.STATUS =
		'10'
		AND UI.USERTYPE = '01'
		AND PI.STATUS NOT IN ('0', '1', '2') AND
		CR.CHANNEL LIKE #{channel}||'%'
		AND CR.INPUTTIME
		BETWEEN #{startDay} AND
		#{endDay}
		ORDER BY CR.INPUTTIME
		DESC, UI.USERID DESC
	</select>
	<select id="queryTotalChannelInvitee" resultType="int">
		select count(*)
		from
		(SELECT ROWNUM RN, UI.PHONETEL, UI.REALNAME,
		CR.INPUTTIME,
		CR.AMOUNT, PI.PROJECTNAME, CR.CHANNEL
		FROM
		NEW_PORTAL.CUSTODY_INVEST_RECORD CR,
		NEW_PORTAL.V_USER_INFO_JOIN UI,
		NEW_PORTAL.PROJECT_INFO PI
		WHERE CR.USERID = UI.USERID
		AND CR.PROJECTID
		= PI.SERIALNO
		AND CR.STATUS = '10'
		AND UI.USERTYPE = '01'
		AND UI.REFERRER
		IS NOT NULL
		AND PI.STATUS
		NOT IN ('0', '1', '2') AND CR.CHANNEL LIKE
		#{channel}||'%'
		AND
		CR.INPUTTIME
		BETWEEN #{startDay} AND #{endDay})m
	</select>
	<select id="getChannelInviteeInfoList" resultType="com.brh.channel.web.service.dto.ChannelInvestDto">
		SELECT M.* FROM (SELECT ROWNUM RN, UI.PHONETEL, UI.REALNAME,
		CR.INPUTTIME, CR.AMOUNT, PI.PROJECTNAME, CR.CHANNEL
		FROM
		NEW_PORTAL.CUSTODY_INVEST_RECORD CR,
		NEW_PORTAL.V_USER_INFO_JOIN UI,
		NEW_PORTAL.PROJECT_INFO PI
		WHERE CR.USERID = UI.USERID
		AND CR.PROJECTID
		= PI.SERIALNO
		AND CR.STATUS = '10'
		AND UI.USERTYPE = '01'
		AND UI.REFERRER
		IS NOT NULL
		AND PI.STATUS
		NOT IN ('0', '1', '2') AND CR.CHANNEL LIKE
		#{channel}||'%'
		AND
		CR.INPUTTIME
		BETWEEN #{startDay} AND #{endDay}
		ORDER
		BY CR.INPUTTIME
		DESC, UI.USERID DESC)M
		<if test="offset != null and limit != null">
			where rn between #{offset} and #{limit}
		</if>
	</select>
	<select id="getChannelInviteeInfoListTotal" resultType="com.brh.channel.web.service.dto.ChannelInvestDto">
		SELECT
		ROWNUM RN, UI.PHONETEL, UI.REALNAME,
		CR.INPUTTIME, CR.AMOUNT,
		PI.PROJECTNAME, CR.CHANNEL
		FROM NEW_PORTAL.CUSTODY_INVEST_RECORD CR,
		NEW_PORTAL.V_USER_INFO_JOIN UI,
		NEW_PORTAL.PROJECT_INFO PI
		WHERE
		CR.USERID = UI.USERID
		AND CR.PROJECTID = PI.SERIALNO
		AND CR.STATUS =
		'10'
		AND UI.USERTYPE = '01'
		AND UI.REFERRER IS NOT NULL
		AND PI.STATUS NOT
		IN ('0', '1', '2') AND
		CR.CHANNEL LIKE #{channel}||'%'
		AND CR.INPUTTIME
		BETWEEN #{startDay} AND
		#{endDay}
		ORDER BY CR.INPUTTIME
		DESC, UI.USERID
		DESC
	</select>
	<select id="queryList"
		resultType="com.brh.channel.web.service.dto.ChannelStatisticsDto">
		select m.* from (select rownum rn,channel.* from (select
		SUM(INVESTSUM)INVESTSUM,COUNT(1) REGISTNUM,SUM(INVESTNUM)
		INVESTNUM,CHANNEL,SUBITEMNAME
		FROM
		(SELECT
		TMP1.USERID,TMP1.CHANNEL,TMP1.SUBITEMNAME,TMP.INVESTSUM,TMP.INVESTNUM
		FROM
		( SELECT
		USER_INFO.USERID,USER_INFO.CHANNEL,SUB_CODE_LIBRARY.SUBITEMNAME
		FROM
		NEW_PORTAL.V_USER_INFO_JOIN USER_INFO,NEW_PORTAL.SUB_CODE_LIBRARY
		WHERE
		USER_INFO.CHANNEL IS NOT
		NULL AND
		USER_INFO.CHANNEL=SUB_CODE_LIBRARY.SUBITEMNO
		AND CREATETIME
		BETWEEN
		#{startDay} AND #{endDay}) TMP1
		LEFT JOIN
		(SELECT
		SUM(USER_CONTRACT.INVESTSUM) INVESTSUM ,COUNT(1)
		INVESTNUM,USER_CONTRACT.USERID
		FROM NEW_PORTAL.INVEST_RECORD
		,NEW_PORTAL.USER_CONTRACT ,NEW_PORTAL.V_USER_INFO_JOIN USER_INFO
		WHERE
		INVEST_RECORD.USERID
		= USER_CONTRACT.USERID AND
		INVEST_RECORD.REBILLNO =
		USER_CONTRACT.CONTRACTID
		GROUP BY USER_CONTRACT.USERID) TMP
		ON
		TMP1.USERID=TMP.USERID )
		GROUP BY CHANNEL,SUBITEMNAME) channel)m
		<if test="offset != null and limit != null">
			where rn between #{offset} and #{limit}
		</if>
	</select>

	<select id="queryTotal" resultType="int">
		select count(*) from (
		select
		SUM(INVESTSUM)INVESTSUM,COUNT(1) REGISTNUM,SUM(INVESTNUM)
		INVESTNUM,CHANNEL,SUBITEMNAME
		FROM
		(SELECT
		TMP1.USERID,TMP1.CHANNEL,TMP1.SUBITEMNAME,TMP.INVESTSUM,TMP.INVESTNUM
		FROM
		( SELECT
		USER_INFO.USERID,USER_INFO.CHANNEL,SUB_CODE_LIBRARY.SUBITEMNAME
		FROM
		NEW_PORTAL.V_USER_INFO_JOIN USER_INFO,NEW_PORTAL.SUB_CODE_LIBRARY
		WHERE
		USER_INFO.CHANNEL IS NOT
		NULL AND
		USER_INFO.CHANNEL=SUB_CODE_LIBRARY.SUBITEMNO
		AND CREATETIME
		BETWEEN
		#{startDay} AND #{endDay}) TMP1
		LEFT JOIN
		(SELECT
		SUM(USER_CONTRACT.INVESTSUM) INVESTSUM ,COUNT(1)
		INVESTNUM,USER_CONTRACT.USERID
		FROM NEW_PORTAL.INVEST_RECORD
		,NEW_PORTAL.USER_CONTRACT ,NEW_PORTAL.V_USER_INFO_JOIN USER_INFO
		WHERE
		INVEST_RECORD.USERID
		= USER_CONTRACT.USERID AND
		INVEST_RECORD.REBILLNO =
		USER_CONTRACT.CONTRACTID
		GROUP BY USER_CONTRACT.USERID) TMP
		ON
		TMP1.USERID=TMP.USERID )
		GROUP BY CHANNEL,SUBITEMNAME)
	</select>
	<select id="getSingleChannelSumInfo"
		resultType="com.brh.channel.web.service.dto.ChannelStatisticsDto">
		SELECT TMP.CHANNEL AS CHANNEL,TMP.REGISTNUM AS
		REGISTNUM,TMP.INVESTUSERTOTAL AS INVESTUSERTOTAL,TMP.TIMESTOTAL AS
		TIMESTOTAL,TMP.AMOUNTTOTAL AS AMOUNTTOTAL,SUB_CODE_LIBRARY.SUBITEMNAME
		AS CHANNELNAME FROM
		( SELECT NVL(VW1.CHANNEL, NVL(VW2.CHANNEL, VW3.CHANNEL)) AS
		CHANNEL,
		NVL(VW1.REGISTERUSERTOTAL, 0) AS REGISTNUM,
		NVL(VW2.INVESTUSERTOTAL, 0)
		AS INVESTUSERTOTAL, NVL(VW3.TIMESTOTAL, 0)
		AS TIMESTOTAL,
		NVL(VW3.AMOUNTTOTAL, 0) AS AMOUNTTOTAL
		FROM (SELECT UI1.CHANNEL,
		COUNT(UI1.USERID) AS REGISTERUSERTOTAL
		FROM NEW_PORTAL.V_USER_INFO_JOIN
		UI1
		WHERE UI1.USERTYPE = '01'
		AND UI1.CHANNEL LIKE #{channel}||'%'
		AND
		UI1.INPUTTIME BETWEEN #{startDay} AND #{endDay}
		GROUP BY UI1.CHANNEL
		)
		VW1
		FULL JOIN
		(SELECT CR2.CHANNEL, COUNT(DISTINCT CR2.USERID) AS
		INVESTUSERTOTAL
		FROM NEW_PORTAL.CUSTODY_INVEST_RECORD CR2,
		NEW_PORTAL.V_USER_INFO_JOIN UI2,
		NEW_PORTAL.PROJECT_INFO PI2
		WHERE
		CR2.USERID = UI2.USERID
		AND CR2.PROJECTID = PI2.SERIALNO
		AND CR2.STATUS
		= '10'
		AND UI2.USERTYPE = '01'
		AND PI2.STATUS NOT IN ('0', '1', '2')
		AND
		CR2.CHANNEL LIKE #{channel}||'%'
		AND CR2.INPUTTIME BETWEEN #{startDay}
		and #{endDay}
		GROUP BY CR2.CHANNEL
		) VW2 ON VW1.CHANNEL = VW2.CHANNEL
		FULL JOIN
		(SELECT CR3.CHANNEL, COUNT(CR3.SERIALNO) AS TIMESTOTAL,
		SUM(NVL(CR3.AMOUNT,
		0)) AS AMOUNTTOTAL
		FROM
		NEW_PORTAL.CUSTODY_INVEST_RECORD CR3,
		NEW_PORTAL.V_USER_INFO_JOIN UI3,
		NEW_PORTAL.PROJECT_INFO PI3
		WHERE CR3.USERID = UI3.USERID
		AND
		CR3.PROJECTID = PI3.SERIALNO
		AND CR3.STATUS = '10'
		AND UI3.USERTYPE =
		'01'
		AND PI3.STATUS NOT IN ('0', '1', '2')
		AND CR3.CHANNEL LIKE
		#{channel}||'%'
		AND CR3.INPUTTIME BETWEEN #{startDay} AND #{endDay}
		GROUP BY CR3.CHANNEL
		) VW3 ON VW2.CHANNEL = VW3.CHANNEL)
		TMP,new_portal.SUB_CODE_LIBRARY
		WHERE
		TMP.CHANNEL=SUB_CODE_LIBRARY.SUBITEMNO
	</select>
</mapper>